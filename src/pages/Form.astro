--- 
import Layout from "../layouts/Layout.astro";
import { category } from '../data/category'
---


      
<Layout>
  <form id="blogForm" class="w-full h-auto flex flex-col items-center">
    <div class="w-[600px] h-auto flex flex-col items-center justify-center gap-5">
      <div class="flex flex-col gap-2 w-full h-full items-center justify-center">
          <img 
          id="preview" 
          class="w-full h-[200px] object-cover rounded-xl relative" 
          src="https://www.contentviewspro.com/wp-content/uploads/2017/07/default_image.png"/>

          <div class="absolute flex flex-col justify-center items-center">
            <label class="font-bold">Image URL</label>
            <input 
            type="url" 
            id="imageLink" 
            name="imageLink"
            placeholder="https://ex.com/image.jpg"
            class="border rounded p-2 w-full focus:outline-none"
            />
          </div>
        </div>

        <div class="w-full ">
          <label for="title" class="block font-semibold">Title</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            class="border w-full p-2 rounded focus:outline-none"
            style="padding-left:10px; padding-right:10px; padding:5px;"
          />
        </div>

        <div class="w-full ">
          <label for="content" class="block font-semibold mb-1">Content</label>
          <textarea
            id="content"
            name="content"
            rows="4"
            required
            class="border w-full min-h-[100px] p-2 rounded focus:outline-none"
            style="padding-left:10px; padding-right:10px; padding:5px;"
          ></textarea>
        </div>

        <div class="w-full ">
          <label for="author" class="block font-semibold mb-1">Author</label>
          <input
            type="text"
            id="author"
            name="author"
            required
            class="border w-full rounded focus:outline-none"
            style="padding-left:10px; padding-right:10px; padding:5px;"
          />
        </div>

        <div>
          <label class="block font-semibold mb-2">Select Tags (max 2)</label>
          <div id="tag-container" class="flex flex-wrap gap-2">
            {Object.entries(category).map(([key,category]) => (
                <button
                type="button"
                style="padding: 7px;"
                class="tag rounded-xl border transition bg-gray-100 text-black border-gray-300"
                data-tag={category.title}
                >
                {category.title}
              </button>
          ))}
        </div>
        <input type="hidden" name="tags" id="tagsInput" />
      </div>

        <button
          type="submit"
          class="w-[50%] h-10 bg-purple-600 text-white p-2 rounded hover:bg-purple-700 transition"
        >
          Submit
        </button>

        <p id="status" class="text-center mt-3 font-medium"></p>
    </div>
  </form>

      <script >
        const blogForm = document.getElementById("blogForm");
        const imageInput = document.getElementById("imageLink") as HTMLInputElement | null;
        const preview = document.getElementById("preview") as HTMLImageElement | null;
        const selectedTags: string[] = [];
        const tagButtons = document.querySelectorAll<HTMLButtonElement>(".tag");
        const tagsInput = document.getElementById("tagsInput") as HTMLInputElement | null;

        // submit logic
        if (blogForm) {
          blogForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const form = e.target;
            if (!(form instanceof HTMLFormElement)) return;

            const formData = new FormData(form);
            const data = {
              image: String(formData.get("imageLink") || "https://www.contentviewspro.com/wp-content/uploads/2017/07/default_image.png"),
              title: String(formData.get("title") ?? ""),
              content: String(formData.get("content") ?? ""),
              author: String(formData.get("author") ?? ""),
              tags: JSON.stringify(selectedTags.length ? selectedTags : ["Lifestyle"]),
              rating: Number(3),
            };

            const statusEl = document.getElementById("status");
            if (statusEl) statusEl.textContent = "Submitting...";

            try {
              const res = await fetch("/api/frontend", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
              });

              if (statusEl) {
                statusEl.textContent = "‚úÖ Post submitted successfully!";
                statusEl.classList.add("text-green-600");
              }
            } catch (err) {
              if (statusEl) {
                statusEl.textContent = "‚ùå Error submitting post.";
                statusEl.classList.add("text-red-600");
              }
              console.error(err);
            }

            form.reset();
          });
        }

        // preview logic
        if (imageInput && preview) {
          imageInput.addEventListener("input", () => {
          const url = imageInput.value.trim();

          if (url.startsWith("http://") || url.startsWith("https://")) {
            preview.src = url;
          } 
        });
      }

      // tags storing
      if (tagsInput && tagButtons.length > 0) {
        tagButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
        const tag = btn.dataset.tag;
        if (!tag) return;

        if (selectedTags.includes(tag)) {
          // üîπ Deselect tag
          selectedTags.splice(selectedTags.indexOf(tag), 1);
          btn.classList.remove("bg-purple-500", "text-white", "border-purple-600");
          btn.classList.add("bg-gray-100", "text-gray-800", "border-gray-300");
        } else {
          // üîπ Limit max 2 selections
          if (selectedTags.length >= 2) {
            alert("You can only select up to 2 tags!");
            return;
          }
          selectedTags.push(tag);
          btn.classList.add("bg-purple-500", "text-white", "border-purple-600");
          btn.classList.remove("bg-gray-100", "text-gray-800", "border-gray-300");
        }

          // üîπ Update hidden input
          tagsInput.value = JSON.stringify(selectedTags);
          });
        });
      } else {
        console.warn("‚ö†Ô∏è Tag buttons or tagsInput not found in DOM");
      }
      </script>

</Layout>